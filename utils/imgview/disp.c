//
// NekoInk Image Viewer
// Copyright 2021 Wenting Zhang
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.
//
// File : disp.c
// Brief: Hardware display related functions
//
#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <stdint.h>
#include <math.h>
#include <assert.h>
#include <string.h>
#include "config.h"
#include "disp.h"
#include "stb_image_resize.h"
#include "stb_image.h"

#if defined(BUILD_PC_SIM)
// Use SDL on PC SIM
#include <SDL.h>
#elif defined(BUILD_NEKOINK)
// Use FBDEV on NekoInk 1st gen
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <linux/mxcfb.h>
#include <sys/mman.h>
#endif

#if defined(BUILD_PC_SIM)
static SDL_Window *window;
static SDL_Renderer *renderer;
static SDL_Texture *texture;
#elif defined(BUILD_NEKOINK)
uint32_t marker_value = 0;
int fd_fbdev;
int fb_virtual_x;
size_t fb_size;
struct fb_var_screeninfo var_screeninfo;
uint8_t *fbdev_fb;
#endif

static Canvas *screen;

static int disp_get_bpp(PixelFormat fmt) {
    switch(fmt) {
    case PIXFMT_Y1_PACKED:
        return 1;
    case PIXFMT_Y2_PACKED:
        return 2;
    case PIXFMT_Y4_PACKED:
        return 4;
    case PIXFMT_Y8:
    case PIXFMT_Y1_LSB:
    case PIXFMT_Y2_LSB:
    case PIXFMT_Y4_LSB:
    case PIXFMT_C1_LSB:
    case PIXFMT_C2_LSB:
    case PIXFMT_C4_LSB:
    case PIXFMT_C8:
        return 8;
    case PIXFMT_RGB565:
    case PIXFMT_RGB565_BE:
        return 16;
    case PIXFMT_RGB888:
        return 24;
    case PIXFMT_ARGB8888:
    case PIXFMT_ARGB8888_BE:
    case PIXFMT_RGBA8888:
    case PIXFMT_RGBA8888_BE:
        return 32;
    }
    return 0; // Unknown
}

static uint8_t disp_get_mask(PixelFormat fmt) {
    switch(fmt) {
    case PIXFMT_Y1_PACKED:
        return 0x01;
    case PIXFMT_Y2_PACKED:
        return 0x03;
    case PIXFMT_Y4_PACKED:
        return 0x0f;
    default:
        return 0x00;
    }
    return 0x00; // Unnecessary, but gcc gives a warning if I don't do so
}

// Framebuffer operation
Canvas *disp_create(int w, int h, PixelFormat fmt) {
    size_t size = w * h;
    int bpp = disp_get_bpp(fmt);
    if (bpp >= 8) {
        size *= (bpp / 8);
    }
    else {
        size /= (8 / bpp);
    }
    Canvas *canvas = malloc(sizeof(Canvas) + size);
    canvas->width = w;
    canvas->height = h;
    canvas->pixelFormat = fmt;
    return canvas;
}

void disp_free(Canvas *canvas) {
    free(canvas);
}

uint32_t disp_conv_pix(PixelFormat dst, PixelFormat src, uint32_t color) {
    int r = 0x00, g = 0x00, b = 0x00, a = 0xff;
    uint8_t y = (uint8_t)color;

    if (src == dst)
        return color;

    switch (src) {
    case PIXFMT_Y1_LSB:
        y = (color) ? 0xff : 0x00;
        r = g = b = y;
        break;
    case PIXFMT_Y2_LSB:
        y |= y << 2; __attribute__ ((fallthrough));
    case PIXFMT_Y4_LSB:
        y |= y << 4; __attribute__ ((fallthrough));
    case PIXFMT_Y8:
        r = g = b = y;
        break;
    case PIXFMT_RGB565:
        r = (color >> 8) & 0xf8;
        g = (color >> 3) & 0xfc;
        b = (color << 3) & 0xf8;
        r |= r >> 5;
        g |= g >> 6;
        b |= b >> 5;
        break;
    case PIXFMT_ARGB8888:
        a = (color >> 24) & 0xff; __attribute__ ((fallthrough));
    case PIXFMT_RGB888:
        r = (color >> 16) & 0xff;
        g = (color >> 8) & 0xff;
        b = (color) & 0xff;
        break;
    case PIXFMT_RGBA8888:
        r = (color >> 24) & 0xff;
        g = (color >> 16) & 0xff;
        b = (color >> 8) & 0xff;
        a = (color) & 0xff;
        break;
    case PIXFMT_ARGB8888_BE:
        b = (color >> 24) & 0xff;
        g = (color >> 16) & 0xff;
        r = (color >> 8) & 0xff;
        a = (color) & 0xff;
        break;
    case PIXFMT_RGBA8888_BE:
        a = (color >> 24) & 0xff;
        b = (color >> 16) & 0xff;
        g = (color >> 8) & 0xff;
        r = (color) & 0xff;
        break;
    default:
        assert(0);
    }

    y = (uint8_t)(r * 0.312f + g * 0.563f + b * 0.125f);
    uint32_t target = 0;
    switch (dst) {
    case PIXFMT_Y1_LSB:
        target = (y >> 7) & 0x1;
        break;
    case PIXFMT_Y2_LSB:
        target = (y >> 6) & 0x3;
        break;
    case PIXFMT_Y4_LSB:
        target = (y >> 4) & 0xf;
        break;
    case PIXFMT_Y8:
        target = y;
        break;
    case PIXFMT_RGB565:
        target = ((r & 0xf8) << 8) | ((g & 0xfc) << 3) | ((b & 0xf8) >> 3);
        break;
    case PIXFMT_ARGB8888:
        target = (a << 24) | (r << 16) | (g << 8) | b;
        break;
    case PIXFMT_RGB888:
        target = (r << 16) | (g << 8) | b;
        break;
    case PIXFMT_RGBA8888:
        target = (r << 24) | (g << 16) | (b << 8) | a;
        break;
    default:
        assert(0);
    }
    return target;
}

// Caution: really slow
void disp_conv(Canvas *dst, Canvas *src) {
    uint8_t *src_raw8 = (uint8_t *)src->buf;
    uint16_t *src_raw16 = (uint16_t *)src->buf;
    uint32_t *src_raw32 = (uint32_t *)src->buf;
    uint8_t *dst_raw8 = (uint8_t *)dst->buf;
    uint16_t *dst_raw16 = (uint16_t *)dst->buf;
    uint32_t *dst_raw32 = (uint32_t *)dst->buf;

    for (int i = 0; i < (src->width * src->height); i++) {
        int bpp = disp_get_bpp(src->pixelFormat);
        uint32_t color;
        if (bpp == 8) {
            color = *src_raw8++;
        }
        else if (bpp == 16) {
            color = *src_raw16++;
        }
        else if (bpp == 24) {
            color = *src_raw8++;
            color <<= 8;
            color |= *src_raw8++;
            color <<= 8;
            color |= *src_raw8++;
        }
        else if (bpp == 32) {
            color = *src_raw32++;
        }
        else {
            assert(0);
        }
        color = disp_conv_pix(dst->pixelFormat, src->pixelFormat, color);
        bpp = disp_get_bpp(dst->pixelFormat);
        if (bpp == 8) {
            *dst_raw8++ = color;
        }
        else if (bpp == 16) {
            *dst_raw16++ = color;
        }
        else if (bpp == 24) {
            *dst_raw8++ = (color >> 16) & 0xff;
            *dst_raw8++ = (color >> 8) & 0xff;
            *dst_raw8++ = (color) & 0xff;
        }
        else if (bpp == 32) {
            *dst_raw32++ = color;
        }
        else {
            assert(0);
        }
    }
}

void disp_scale_image_fit(Canvas *src, Canvas *dst) {
    if ((dst->height == src->height) && (dst->width == src->width)) {
        memcpy(dst->buf, src->buf,
                disp_get_bpp(dst->pixelFormat) / 8 * dst->height * dst->width);
        return;
    }

    float scalex, scaley;
    scalex = (float)dst->width / (float)src->width;
    scaley = (float)dst->height / (float)src->height;
    int channels = disp_get_bpp(src->pixelFormat);
    // Source and dest should have the same pixel format
    assert(channels == disp_get_bpp(dst->pixelFormat));
    // The pixel format should not be packed
    assert(channels >= 8);
    channels /= 8;
    // Assume byte per pixel is equal to channel count
    // Fit the image into destination size keeping aspect ratio
    int outh, outw, outstride, outoffset;
    if (scalex > scaley) {
        outh = dst->height;
        outw = src->width * scaley;
        outoffset = ((dst->width - outw) / 2) * channels;
        outstride = dst->width * channels;
    }
    else {
        outw = dst->width;
        outh = src->height * scalex;
        outoffset = ((dst->height - outh) / 2) * channels * dst->width;
        outstride = 0;
    }
    stbir_resize_uint8(src->buf, src->width, src->height, 0,
            dst->buf + outoffset, outw, outh, outstride, channels);
}

// For a certain pixel, get its color component on the EPD screen,
// return in the RSH amount to get the component
static uint32_t get_panel_color_shift(int x, int y) {
    int c = (x + (DISP_HEIGHT - y)) % 3;
    if (c == 0)
        return 16; // r
    else if (c == 1)
        return 0; // b
    else
        return 8; // g
}

static uint32_t get_panel_color_component(int x, int y) {
    int c = (x + (DISP_HEIGHT - y)) % 3;
    if (c == 0)
        return 0; // r
    else if (c == 1)
        return 2; // b
    else
        return 1; // g
}

static float degamma_table[256];
static uint8_t gamma_table[256];

static void build_gamma_table(void) {
    for (int i = 0; i < 256; i++) {
        degamma_table[i] = powf(i / 255.0f, DISP_GAMMA);
        int32_t srgbi = powf(i / 255.0f, 1.0f / DISP_GAMMA) * 255.0f;
        if (srgbi > 255) srgbi = 255;
        if (srgbi < 0) srgbi = 0;
        gamma_table[i] = srgbi;
        printf("%d: %d\n", i, gamma_table[i]);
    }
}

static float srgb_to_linear(uint8_t val) {
#if 0
    float srgb = val / 255.0f;
    float linear = powf(srgb, DISP_GAMMA);
    return linear;
#else
    return degamma_table[val];
#endif
}

// Not accurate, good enough for 4bpp
static uint8_t linear_to_srgb(float val) {
#if 0
    float srgb = powf(val, 1.0f / DISP_GAMMA);
    int32_t srgbi = srgb * 255.0f;
    if (srgbi > 255) srgbi = 255;
    if (srgbi < 0) srgbi = 0;
    return srgbi;
#else
    size_t index = (size_t)(val * 255.0f);
    if (index > 255) index = 255;
    return gamma_table[index];
#endif
}

#ifdef DITHERING_ORDERED
#ifdef ENABLE_COLOR
// RBGRBGRBG
// GRBGRBGRB
// BGRBGRBGR
int8_t dithering_map[36] = {
    64, 107, 107, 
    85, 43, -64, 
    -21, 43, -85, 
    85, 107, -43, 
    -107, -107, -43, 
    21, 64, 0, 
    -64, 0, 0, 
    21, 64, 43, 
    -85, -21, 85, 
    -128, -85, -21, 
    -128, -43, -107, 
    -64, 21, -128, 
};
#else
// Classic bayer map
int8_t dithering_map[4][4] = {
    // 16 32 48 64 80 96 112 128 
    {-128, 0, -96, 32},
    {64, -64, 96, -32},
    {-80, 48, -112, 16},
    {112, -16, 80, -48}
};
#endif
#endif

#ifdef DITHERING_BLUE_NOISE
#ifdef ENABLE_COLOR
int8_t noise_map[120][40] = {
    {14, 98, -98, 31, -24, 89, 6, 45, -75, 62, -32, 40, -68, 108, -82, -12, 122, -92, -41, 81, -116, -10, -73, 89, 21, -64, -88, 54, 126, -4, 65, -110, 121, -38, 41, -60, -79, -124, 36, -63, },
    {-109, 63, -47, 127, 70, -113, 103, -17, 116, -58, 95, -94, 1, -44, 65, -58, 36, 96, 21, -60, 5, 121, 53, -103, -26, 79, 102, -100, 25, 87, -46, 9, 30, -88, -114, 56, 87, 124, -32, 52, },
    {91, -59, -11, -86, 16, -68, 57, -100, 78, -124, 15, 74, 53, -111, 91, 14, -117, 57, -22, -105, 30, -35, -52, 38, 113, -45, 7, -17, -58, -126, -81, 105, -67, -25, 111, 0, -49, 25, -87, 4, },
    {-24, 39, 105, -126, -33, -6, 28, -48, -27, 34, -80, -15, 127, 25, -25, -97, 74, -3, -79, 110, 71, 94, -123, 14, -79, 62, -112, 47, 115, 74, 40, -9, 63, 91, 19, -104, -14, 74, -99, 114, },
    {-118, -76, 23, 52, 79, 98, -92, 123, 4, 106, -40, -105, -53, -76, 109, -38, -65, 124, -47, 44, -89, -68, -2, 75, -94, -10, 98, -71, -30, 13, -41, -98, 47, -54, -123, 80, 37, -66, -40, 68, },
    {-4, 85, -43, 113, -105, -57, 43, -75, -110, 63, 45, 99, -4, 82, 36, 49, 10, 85, -120, 17, -15, 59, 104, -27, 123, 31, -54, 22, -89, 94, -114, 119, -75, 7, -33, 122, -79, 99, 48, 14, },
    {125, -96, -66, 6, -16, 66, 13, 89, -9, -63, 18, -93, 70, -127, -19, -88, -107, -9, 102, -32, -101, 27, -58, -113, -40, 55, 84, -120, 65, 0, 33, -23, 103, 71, -91, 55, -5, -22, -113, -52, },
    {55, 72, -28, 35, -82, -116, -41, -24, 77, -120, 120, -31, 7, -70, 59, 117, -54, 29, 53, -71, 118, 83, 4, 42, -75, -105, -6, -22, 127, -51, 83, -62, -11, 28, -47, 16, -102, 110, 31, -85, },
    {-17, 20, -122, 120, 49, 96, 111, 22, -87, 55, -55, 32, 96, -43, 20, 88, -29, 73, -95, -42, 64, -126, -20, 113, 92, 16, 106, -67, 49, -102, -81, 60, -107, -118, 116, 90, -59, 66, -36, 93, },
    {-108, 105, -55, 77, -4, -69, -98, -51, 40, 92, -16, -80, -110, 110, -11, -118, -81, 6, 98, -6, 37, -80, -48, -94, 68, -32, -87, 76, 37, -34, 19, 4, 99, 39, -28, -76, 46, -126, 2, -70, },
    {44, -42, 10, -91, -34, 29, 60, 6, 116, -104, 0, 72, 48, -95, 35, -62, 122, 45, -114, -58, 128, 22, 9, 51, -60, 30, 1, -45, -125, -14, 118, 86, -42, -87, 75, 10, -14, 84, 26, 117, },
    {-7, -79, 63, 100, -111, 85, -14, -125, -28, -67, -38, 125, 11, -50, 61, 79, -38, 18, -19, 89, -106, 75, 102, -11, -110, 121, -99, 90, 108, 61, -70, -96, 50, -2, -62, 105, -99, -46, -89, 71, },
    {91, -101, 35, -19, -62, 123, -80, 69, 105, 27, 83, -119, -73, -23, 104, -2, -101, -69, 56, -86, -27, -39, -70, -119, 81, -24, 55, -77, 10, -112, 29, -53, -20, 120, -120, 20, 60, 128, -25, -58, },
    {-121, -32, 115, 22, 53, -45, 16, 43, -57, -88, 58, -10, 95, 24, -85, -125, 114, 31, 71, 110, 3, 26, 61, 116, -49, 17, 35, -56, -8, -30, 74, 101, -108, 64, 34, -33, -73, -111, 38, 15, },
    {57, 78, -71, 2, -116, -95, -6, 95, -108, 3, 38, -99, -59, 68, 47, -29, 92, -12, -49, -120, 48, -100, -82, 41, -3, -90, 104, 65, 126, -87, 41, 16, -40, -79, 86, -9, 96, 50, 3, 109, },
    {-13, -92, -51, 93, 72, 110, -34, 78, -21, -47, 107, 17, 117, -109, -45, 9, -76, -95, 14, -65, 101, -16, 87, -33, 96, -66, -109, -38, -118, 93, -67, -12, 108, 6, -93, -55, 74, -43, -84, -64, },
    {29, 124, 45, -24, -78, 36, -65, -121, 128, 63, -75, -35, -16, 85, 34, 126, 59, 78, 40, 119, -42, 73, -59, -126, 9, 70, -16, 26, 49, 3, -99, 80, -126, 46, 123, 25, -103, -21, 100, -114, },
    {-36, 0, -127, 17, -107, 59, 5, 23, -86, 45, -114, 76, -91, -66, -1, -114, -56, -33, -105, -2, -90, 16, 29, 125, 52, -101, 115, 85, -58, -24, 119, -47, 58, -62, -31, -116, 113, 12, 60, 82, },
    {-57, 103, 66, -42, 119, -15, 99, -52, 89, -10, 30, 7, 102, 50, -26, -82, 100, 27, 91, -22, 60, -109, -76, -9, -29, -48, -73, 13, -85, 66, 31, -77, 18, -15, 72, 34, -5, -78, 41, -97, },
    {20, -82, -9, 86, -59, -91, 48, -101, -28, -69, 118, -44, -124, 25, 112, 70, -10, -119, 49, -70, 114, 84, 37, 107, -92, 77, 41, -5, -122, 110, -35, -110, 103, -89, 96, -70, 88, -49, -28, 117, },
    {-111, 55, -69, -104, 28, 75, -37, 106, 12, 69, -106, 56, -57, 83, -98, 13, -42, 122, -88, -49, 7, -35, -56, -115, 62, 22, 102, -104, 90, 51, -13, 78, 4, 44, -40, -100, 65, -124, 3, 75, },
    {-20, 94, 10, 43, 113, 1, -77, -123, 35, 85, -83, -2, -32, -15, -74, 43, -62, 62, 21, 76, -122, 46, 97, -18, 3, -67, -39, -21, -53, 19, -96, -64, 127, -120, -21, 15, 120, 47, -65, 32, },
    {-94, 127, -48, -30, -115, -19, 64, 122, -53, -23, 23, 97, 126, 61, -110, 95, 3, -103, -20, 109, -8, -95, 18, -81, 80, 116, -117, 58, 121, -74, 38, -44, 63, 28, -55, 99, -10, -86, 105, -41, },
    {-6, -122, 69, -83, 98, 21, -66, -8, -111, 51, -97, -65, 11, -88, 29, 116, -30, 84, -78, 31, -63, 64, 128, -46, -102, 48, 25, -88, 73, 7, 105, -5, -105, 86, -76, 56, -34, -112, 17, 85, },
    {-72, 50, 33, -58, 80, -98, 56, 92, 5, 115, -44, 38, -121, 75, -52, -7, -127, 41, -47, 96, -108, -27, 88, 37, -31, -3, -61, -10, -34, -125, 91, -82, -30, 115, 9, -95, 34, 78, -53, 59, },
    {115, 3, -25, 107, 12, -46, 39, -33, -89, 70, 102, -17, 87, -38, 49, -69, 69, -91, 120, 11, 55, 1, -71, -124, 106, 65, 113, 84, 33, -99, 53, -19, 42, -116, 69, -61, -1, 122, -18, -104, },
    {-36, 90, -91, -110, -10, 125, -126, -78, 27, -58, -106, -3, -77, 113, 8, 102, 22, -13, -34, -117, 75, -87, 28, -53, 11, -93, -111, -72, -46, 15, 124, -53, 80, 21, -41, 108, -127, 44, -84, 25, },
    {-118, -61, 28, 45, -71, 67, -18, 112, 79, -26, 46, 19, 64, -113, -23, -103, -81, 89, 48, -61, 112, -21, 102, 53, -15, 93, 42, -24, 62, 98, -65, 4, -92, -74, -12, 91, -27, -69, 97, 72, },
    {14, 111, 57, -40, 102, 8, -55, 52, 14, -119, -69, 122, -93, 32, -55, 59, 126, -49, 29, -99, -4, -44, -104, 82, -78, -38, 19, 119, -86, -13, -107, 70, 106, 36, 54, -106, 8, 62, -46, -7, },
    {-78, -16, -100, 77, -86, -114, 88, -97, -7, 105, 89, -50, -31, 78, 96, -1, -119, 13, 81, -73, 63, 39, 9, 125, -115, 71, -57, 2, -123, 50, 27, -31, -115, -50, 83, -86, 28, 127, -96, 39, },
    {86, -53, 121, -1, -23, 23, -35, 36, -82, -41, 56, 6, 39, -83, -14, -66, 42, -33, -18, 118, 98, -122, -31, -64, -5, 33, -98, 104, 79, -45, 92, -3, 120, 16, -22, 111, -60, -35, -115, 104, },
    {-28, -125, 65, -69, 41, 97, 118, -62, 69, -110, -16, -101, 111, -125, 21, 115, -94, 73, -111, -83, -52, 19, 78, 51, -88, 115, 60, -34, -68, 38, -81, -98, 61, -71, -121, 46, -8, 75, 58, 4, },
    {50, 32, 15, -109, -48, 55, -123, 2, 84, 128, 25, -72, 66, -39, 87, 49, -47, 106, 6, 54, 34, -96, -14, 93, -48, 22, -22, -117, 13, 127, -17, -57, 78, -38, 4, 99, -101, 21, -70, -90, },
    {-61, -42, 99, 82, -91, -11, -76, 18, -25, -53, 43, 97, -2, -60, 10, -106, -75, 27, -8, 90, -38, -71, 108, 4, -113, -77, 97, -8, 54, -107, 101, 23, 49, 117, 32, -81, -47, 89, -15, 120, },
    {70, -82, -5, 126, -30, 73, 110, -100, 62, -87, -115, -30, -96, 79, -18, 123, -28, 65, -62, -125, 126, 68, -106, -27, 64, 41, 81, -90, -52, 71, 2, -126, -88, -19, -111, 67, -26, 110, -107, 11, },
    {103, -19, -101, 26, -65, 44, -43, 33, -6, 106, 12, 52, 116, 36, -84, 58, -113, 101, -89, -21, 15, 43, -55, 28, 121, -63, -39, 110, 32, -73, -28, -43, 87, -64, 14, 82, 51, -57, 38, -117, },
    {-33, 47, 62, -122, 8, 95, -112, -59, 75, -37, 91, -67, -47, -123, 19, 95, 3, 38, -43, 80, -4, -80, 88, -93, 10, -124, -1, -102, 16, 91, 119, 64, 36, 104, -4, -94, -73, 24, -2, 79, },
    {-77, 18, -51, 112, -84, -22, 57, 121, -78, -119, -14, 26, 69, -6, -73, -37, -58, -100, 113, 51, -117, 117, -35, -12, 99, 53, 73, -17, 48, -115, -84, -13, -101, -53, 125, -31, -119, 114, -45, -95, },
    {119, -63, 73, 34, 86, -1, -96, 23, 5, 83, -90, 124, -107, 110, 46, 82, -11, 71, 24, -69, -50, 62, -110, 37, -73, -48, -87, 125, -34, -56, 8, 56, 21, -113, 42, 61, 97, -15, 54, 90, },
    {-25, 2, -114, -12, -41, -70, 108, -51, 40, -24, 49, -56, 9, -29, -94, 104, -120, 10, -85, -26, 106, 3, 18, 85, -24, 107, 23, -66, 82, 31, 100, -72, 79, -41, 6, -67, -85, 31, 10, -127, },
    {42, 104, -90, 123, -106, 49, 68, -32, -103, 103, 63, -80, 89, 36, -64, 60, -20, 128, 34, 87, -95, 46, -62, 73, -103, -119, 60, -2, -96, -122, 115, -27, -90, 111, 89, -22, 74, -108, -59, 66, },
    {-79, 19, 55, -28, 80, 14, -121, 93, -64, -5, -126, -39, -15, -115, 22, -46, -77, -106, -39, 66, -127, -18, -81, -40, 122, 9, 42, 93, -19, 70, -46, 1, 50, -9, -123, 23, -48, 123, -6, -39, },
    {-104, 95, -47, -60, 28, -7, -85, 34, 127, 11, 27, 116, 70, 98, -4, 111, 50, 92, -61, 20, -3, 95, 112, 30, -7, -86, -31, -51, -79, 16, 37, -111, -60, 67, -77, 99, 40, -92, 108, 84, },
    {33, -11, -112, 101, -76, 113, -19, -44, 74, -75, -95, -51, 43, -105, -86, 75, 7, -14, 38, 120, -73, -46, 54, -98, 66, -61, 103, -109, 119, 57, 96, -97, 128, 13, -34, -103, 57, -25, 14, -69, },
    {-29, 72, 8, 60, 44, -96, 87, -116, 46, -27, 58, 86, -67, 15, -31, -55, -123, -93, -30, -114, 74, 11, -110, -22, 86, 21, 48, 76, -8, -68, -37, 81, -18, 30, 107, -64, 2, 76, -117, 53, },
    {-94, -63, 126, -125, -36, 2, 64, -57, -8, 109, -112, 3, -19, 122, 61, 31, 115, 84, 53, 100, -88, 44, -57, 105, -72, -118, -16, -92, 29, -125, 8, -83, -53, 47, -119, 88, -13, -82, -51, 115, },
    {-4, 82, -84, -22, 24, -71, 121, 17, -101, 96, -39, 24, -80, -118, 103, -43, -77, 16, -63, -7, -42, 118, 0, 34, -35, 126, 13, -45, 109, -27, 52, 116, -4, 73, -89, -43, 124, 37, 93, 20, },
    {46, -44, 36, 103, 91, -108, -46, 78, -84, 33, -61, 71, 94, 39, -99, 0, -17, 68, -103, 29, -26, 65, -124, 80, -85, 61, -56, 88, 39, 68, -100, 98, -112, -70, 24, 63, 8, -105, -34, -121, },
    {67, -100, 12, -57, -12, 39, 55, -26, 8, 117, 49, -93, -7, -27, -58, 82, 46, -117, 125, 89, -75, -97, 18, -11, 97, -104, 3, -114, -79, -63, 19, -46, 35, -30, 109, -20, -62, 54, -74, 109, },
    {-24, -69, 118, -115, 73, -90, 108, -124, -67, -15, -116, -45, 127, 56, 12, -87, 98, -34, -52, 6, 55, 109, -64, -49, 42, -29, 52, 104, -7, 124, -19, 79, 4, 91, -95, -126, 81, 18, 99, -9, },
    {27, 89, 1, 52, -40, -75, -2, 29, 98, 61, 88, 20, -73, 78, -127, 113, -70, 20, 41, -112, -19, 75, 31, -110, 121, -74, 73, 26, -37, -89, -118, 59, -78, -56, 43, 121, -3, -91, -53, -113, },
    {-83, 61, -95, -30, 21, 125, 82, -52, -36, -104, 5, -29, -108, -51, 33, -22, 62, -6, -93, 115, -84, -38, -2, 87, 15, -16, -97, -59, 83, 10, 46, 115, -109, -13, 68, -41, 30, -28, 72, 127, },
    {-43, 37, -62, 104, -120, -17, 64, -96, 41, -80, 111, 69, 45, 106, 3, -101, -44, 74, 93, -58, 49, 99, -120, 61, -88, -42, 113, -127, 35, 99, -50, -31, 26, 102, 11, -106, -77, 92, 45, 9, },
    {-102, 113, -8, 86, 44, -106, -65, 15, 119, -8, -59, 26, -92, -14, 85, -81, 121, -121, 28, -13, 13, -75, -24, -55, 103, 47, 5, 63, -12, -103, -70, -1, 76, -89, -64, 116, 58, -120, -66, -15, },
    {-116, 17, 67, -81, -47, 1, 99, 56, -23, 77, -115, 94, -70, -38, 57, 15, 39, -67, -33, -108, 69, 128, 38, -103, 25, 76, -68, -27, 121, -83, 54, 93, -123, -43, 39, -19, 2, 106, -33, 80, },
    {56, -54, -24, -100, 32, 73, -33, -126, -87, -45, 51, 0, 124, -123, -57, 101, -25, 110, 53, 88, -95, -45, 0, 83, -10, -81, -113, -46, 87, 12, 30, -22, 126, 64, 19, 86, -49, -93, 24, 120, },
    {-1, -72, 91, 109, 11, 122, -76, 24, 105, 37, -102, 17, -27, 67, 31, -111, -91, -3, -52, 7, 24, 106, -67, -123, 119, 17, 108, 40, -94, 71, -111, -56, -6, -98, -74, -110, 52, 71, -80, 36, },
    {102, -91, 41, -37, -116, -60, -5, 86, -18, -54, 114, 80, -80, -9, 93, 8, 79, -76, 66, -119, -82, -30, 57, 44, -39, -21, -60, 59, -8, -37, 107, -80, 48, 112, -25, 97, -60, -8, -127, -44, },
    {-19, -111, 77, -11, 60, -92, 49, -108, 67, 5, -67, -95, -41, 48, -104, -47, 125, -19, 41, 118, 91, -14, 74, -89, 94, -100, 28, 98, -124, -66, 22, 80, 6, -40, 33, 11, 123, -31, 87, 14, },
    {65, -65, 128, 20, -50, 96, 33, -40, 119, -116, 56, 98, 35, 108, -63, 25, 55, -35, -100, -59, 32, -112, 13, -51, -2, 67, -76, 5, 123, 53, -28, 95, -121, -87, 77, -114, 42, -95, 108, 49, },
    {-52, 30, 4, -122, -27, 112, -69, 11, -83, -25, 22, -4, -120, -17, 72, -85, -126, 15, 84, -5, -41, 101, -72, 125, 36, -117, 84, -48, -88, -15, -103, 37, -52, 63, -13, -68, -47, 0, -75, -106, },
    {117, -88, 86, -77, 69, -105, 82, -12, 44, 77, -48, 87, -76, -30, 117, 0, 99, -68, 112, 62, -93, 50, -25, -106, 105, -11, -32, 45, 16, 69, 110, -71, 1, 102, 24, 115, 83, 56, 20, -25, },
    {-9, -35, 105, 51, -1, 27, -54, -125, 103, -98, -62, 122, 11, -108, 59, -51, 40, -13, -113, -78, 29, 1, 81, -60, 56, 23, -97, 117, -59, -119, 87, -42, -95, 51, -107, -22, -82, -122, 94, 72, },
    {-115, 42, -99, -45, -18, -90, 57, 126, -35, 32, 67, -88, 45, 28, 80, -100, -33, 23, 75, -52, 121, -120, 17, -86, -40, 73, -68, 92, -23, 32, -9, 12, 127, -31, -60, 67, 13, -39, 35, -64, },
    {8, 63, 17, -68, 115, 92, 5, -76, 17, -8, -116, -20, 103, -39, -72, 94, -90, 54, 109, -20, -37, 68, 92, -14, 111, -127, 8, -84, 51, -111, 61, -78, 78, 43, -117, 107, -6, 124, -94, 100, },
    {-54, 122, 82, -120, 35, -31, -113, 72, -47, 99, 54, 4, -55, -123, -9, 128, 6, -62, -105, 12, 45, -69, -100, 40, -50, 31, -6, 102, -38, 120, -51, -102, 27, -16, -85, 85, -53, 50, -77, -16, },
    {-110, -37, -83, -4, 74, -61, 47, 111, -107, -67, 82, -81, 110, 70, 19, 47, -25, 83, -122, 96, -85, 107, -1, -28, 127, 65, -108, 79, 21, -71, 4, 108, 93, -45, 2, 33, -104, -27, 77, 28, },
    {90, 51, -23, 102, -103, 22, -14, -88, 40, -25, 26, -102, -32, 36, -111, -47, -79, 67, 33, -11, -44, 26, -118, 55, -90, -74, -57, -18, 43, -94, 70, -27, -119, -66, 57, 97, 16, -124, 114, 1, },
    {-97, -70, 31, -51, 59, 123, -41, 90, -2, 64, 125, 9, 87, -67, 118, -94, 101, -1, -56, 123, 59, 78, -61, 87, 18, 97, -32, 115, -123, 89, -9, 39, 18, 119, -97, -74, 71, -42, -61, 60, },
    {-14, 12, 111, -123, 4, -73, -99, 15, -59, -127, -43, -92, 51, -5, -20, 58, 25, -103, -31, -73, -95, 8, -18, -109, 45, 3, -99, 58, 13, -45, -60, -86, 65, -36, -7, 105, -20, 39, -85, 96, },
    {-114, 43, 70, -86, 82, -18, 50, 104, 74, -78, -13, 97, -54, -119, 77, -39, 11, 113, 85, 39, -115, 109, -37, 121, -49, -10, 73, 30, -79, 100, 126, -107, 81, 46, -55, 9, -112, 128, 21, -34, },
    {-56, 122, -44, -28, 99, 29, -117, -32, 114, 33, 58, 18, 116, 42, -83, 95, -65, -124, 49, -23, 19, 68, -71, 32, -84, 105, -64, -111, -36, 49, 7, -18, 26, -126, -81, 85, 64, -101, -2, 76, },
    {-78, -7, -100, 19, -63, 66, -50, -90, 2, -103, -24, -114, -72, 1, 28, -107, 68, -12, -52, 103, -89, -4, 93, 53, -121, 84, -22, 116, -3, 75, -96, -67, 94, -28, 112, 31, -47, -68, 53, 104, },
    {-125, 85, 58, 1, -111, 118, -10, 41, 83, -65, 92, 67, -33, 106, -22, -49, 122, 6, -80, 78, -41, -105, -57, -26, 23, -93, 11, 60, -54, -122, 37, 107, -44, 1, 51, -93, -15, 94, -26, 27, },
    {-39, 33, 112, -71, 47, 90, -79, 12, -40, 123, 24, -51, -98, 51, 84, -90, 36, 59, -102, 30, 124, 47, 5, 108, 65, -45, 41, -76, 92, -29, -83, 17, 64, -115, -74, 14, 117, -117, 8, -89, },
    {67, -58, -20, -92, -34, 26, -124, 71, -106, 47, -7, -85, 118, 11, -112, -7, -36, 90, -70, 15, -17, -126, 88, -78, -114, 128, -13, -105, 21, 120, 83, -11, -59, 125, 79, -35, 62, -54, 45, 109, },
    {-108, 95, 10, 74, 127, -17, -56, 110, -70, -23, -118, 79, 32, -63, 71, 103, -58, -118, 112, -31, 69, -62, 36, -7, -34, -61, 98, 70, 1, -41, 52, -111, 40, -98, -6, 33, -105, 86, -71, -12, },
    {-81, 50, -116, -48, -101, 62, 0, 96, 18, 56, 100, 5, -38, -16, -79, 43, 22, 0, 52, -93, -48, 118, -86, 17, 79, 48, -94, 30, -119, -65, -89, -23, 95, -48, 104, -83, -21, 20, 124, 3, },
    {77, -36, 23, 103, 42, -83, 33, -32, -96, -46, -75, -101, 112, 59, -125, 127, -24, -104, 100, -13, 81, -109, 55, 101, -105, 9, -21, -50, 114, 77, 107, 12, 68, 24, -66, 55, 72, -121, -50, 37, },
    {-99, 119, -73, -7, 88, -64, -118, 81, -11, 124, 69, 39, -54, 18, -91, 80, -44, 66, -77, 40, 7, 25, -25, -43, -73, 120, 63, -81, -29, 36, -5, -75, -36, -123, 1, 113, -38, -90, 99, -26, },
    {-1, 64, -123, -23, 15, -41, 118, 46, -86, 27, -122, 88, -4, -30, 94, -66, 9, 29, -53, 89, -123, -66, 111, 73, -9, -113, 40, 96, 18, -106, 60, -96, 121, 47, -107, -15, 88, 9, 52, -65, },
    {83, 30, -56, 111, 56, -109, 3, 63, -60, 11, -19, -68, 107, -102, 46, -13, -116, 106, -86, 123, -34, -1, -95, 31, -55, 84, 2, -63, -127, 90, -53, -18, 76, 94, -80, 38, -57, 28, -115, 114, },
    {-43, -86, 45, -96, 78, -78, 105, -28, -105, 114, -37, 54, -82, 25, 68, 118, -37, 58, -108, -18, 44, 61, 95, -118, 50, -35, -91, -15, 119, -39, 44, 29, -62, 6, -44, 128, -99, 70, -77, -17, },
    {-108, 92, 6, -33, 25, -13, -50, 90, 29, 73, -113, 83, 2, -119, -51, -75, 38, -5, 19, 75, -74, -51, 14, -81, 126, 21, 105, 55, 69, 10, -86, 112, -118, -26, 21, 57, -5, -32, 102, 16, },
    {60, -10, 126, -67, 101, -127, 40, -92, -74, -6, -46, 35, 126, -23, 97, 7, -92, 85, -61, 101, -101, 117, -13, 69, -25, -70, -112, -46, -100, -73, -3, 82, -104, 65, -89, 107, -126, 78, -60, 40, },
    {-119, -50, 70, -105, 54, 0, 67, 123, 13, 58, 104, -97, -59, 19, 74, -107, 113, -43, -127, -26, 5, 35, -42, -104, 90, 7, 38, 79, 25, 97, -33, 48, -12, 95, -50, -69, -20, 9, -94, 119, },
    {-74, -24, 32, -82, -57, -20, -38, -116, -61, -24, -84, -10, 51, -72, -32, 61, -15, 26, 48, 67, -85, 86, -120, 47, 113, -57, -11, -80, -23, 122, -115, -65, 13, 117, 28, 42, 87, 53, -40, 24, },
    {-3, 81, 114, 15, 90, 109, 23, 80, 98, 45, -112, 88, 116, -124, 39, -85, 94, -70, 119, -53, 107, 20, -66, -3, -88, 61, -125, 108, 54, -53, 35, 72, -42, -79, -101, -1, -112, -83, 109, 94, },
    {58, -96, -42, -121, 47, -90, -71, -101, 3, -36, 66, 14, -42, -2, 81, -50, 12, -116, 1, -97, -10, 57, -29, 76, 26, -35, 93, 14, -106, -1, -92, 90, -124, 57, -28, 125, 70, -55, -14, -116, },
    {-63, 43, -29, 6, 76, -9, -46, 39, 118, 27, -76, -56, 108, 29, -94, 123, -25, 59, 35, -36, -74, -108, 100, -50, 120, -98, 43, -69, -41, 66, 22, 114, -15, 7, 101, -68, 20, -31, 36, 12, },
    {122, -85, 96, -109, -61, 128, 62, -125, -16, -92, 79, -105, -20, -113, 53, -62, 104, -103, 87, 71, 126, 44, 10, -115, -78, -17, 2, 82, 127, -83, -30, -59, 42, 77, -49, -93, 50, 91, -102, 77, },
    {-8, 22, 106, -19, 52, 29, -34, 94, -64, 110, 0, 40, 100, 68, -8, 20, -81, -14, -48, 24, -88, -21, 91, 34, 68, 105, -54, -121, 32, -10, 99, -114, -74, -107, 29, -6, -122, 114, -75, -45, },
    {-111, -55, 67, -75, -102, 9, -84, 73, 18, -49, 57, -30, -85, -69, -41, 76, 43, -121, 114, 4, -61, -124, -42, -5, -63, 17, 53, -24, 74, -97, 15, 56, 83, -19, 122, 65, -39, 7, -20, 62, },
    {85, 35, 0, -40, 89, 112, -117, -5, 48, -98, -120, 124, 5, 90, -117, 9, 97, -29, -72, 81, 51, 107, 62, -102, 84, -89, -110, 112, -71, -49, 38, 108, -37, 11, -82, 87, -64, 100, 46, -89, },
    {-30, -126, 123, -91, 41, -51, -26, -72, 100, -20, 81, 23, -59, 33, 109, -92, -54, 63, 31, -110, -11, 19, -79, -26, 124, 44, -36, 92, 3, 63, -118, -3, -91, -54, 50, -100, 37, -115, 24, 111, },
    {-62, 16, 55, -14, 78, 22, 67, 121, 35, -41, -77, 65, -105, -33, -17, 52, 128, -4, -99, -39, 120, -54, 95, 8, 30, -51, -12, 24, -84, 121, -21, -64, 89, 114, 20, -27, -10, -50, -80, -2, },
    {91, -98, 101, -68, -108, 4, -58, -112, -92, 13, 112, -7, 44, 84, -71, -110, 23, -83, 89, 72, 37, -91, -118, 76, -70, -107, 70, -127, 50, -40, 75, 27, -109, 62, -125, 103, 80, 127, 57, 72, },
    {-17, -47, 30, -33, 110, -83, 91, 59, -12, 96, -127, -52, -90, 118, 2, 71, -49, -26, 13, -69, -18, 47, -34, 55, -3, 117, 101, -60, 13, -99, 98, -78, 42, -35, 1, -73, -94, 10, -37, -107, },
    {119, -76, -4, 64, -122, -23, 45, 26, -37, -66, 76, 54, 17, -43, 101, -121, 41, 95, 116, -125, 2, 100, 112, -98, -21, -82, 38, -30, 84, -9, -53, 7, 119, -16, -48, 69, 30, -60, -121, 41, },
    {52, -89, 86, 38, 14, 116, -50, -103, 127, 6, 36, -106, -22, -80, 30, -13, -63, 53, -102, 62, -58, -79, 12, -47, 86, 20, 61, -93, 127, -115, 34, 58, -89, -104, 95, 46, 115, -22, 98, 20, },
    {5, 107, -106, -41, -65, 74, -2, -75, 84, -87, -31, 108, 93, 61, -98, 123, -34, -87, -6, -43, 27, 81, -113, 35, -63, -122, -42, 0, -72, 68, -27, 102, -63, 76, 14, -117, -83, -5, 78, -69, },
    {-113, -54, 71, -9, -94, 95, -118, 51, -16, 64, -116, -56, -2, -69, 76, 7, 85, 34, 109, 73, -28, 126, -12, 65, 98, 115, -17, 47, 108, 22, -45, -124, -10, 26, -32, -52, 55, -99, -44, -29, },
    {90, -19, 27, 124, 56, -29, 21, 106, -44, 16, 116, 28, 49, -112, 22, -52, -107, -74, 17, -117, -96, 44, -87, -33, -108, 6, 75, -56, -110, -84, 82, 49, 123, -78, 111, 85, 4, 34, 125, 60, },
    {13, 45, -75, -126, 8, -83, -55, 41, -97, -68, 72, -82, -11, -38, 107, -23, 66, 97, -17, -61, 5, 105, -67, 23, 54, -76, -97, 31, 94, 10, -21, -99, -1, 39, -112, 65, -71, 104, -120, -85, },
    {113, -97, -35, 98, 37, 79, 120, -108, 0, 89, -26, -119, 125, 87, -91, 38, -122, 48, 121, -46, 57, 90, -2, -50, 84, -26, 124, -8, -36, -65, 60, 96, -58, -40, -91, -14, -26, -56, 24, -11, },
    {-66, 83, 63, -50, -21, -65, -10, 59, -37, 101, 11, 32, -48, 58, 5, -63, -5, -35, -84, 79, 32, -126, -103, 114, 37, 15, -120, 66, 44, 112, -113, 19, 73, 106, 10, 50, 93, -105, 75, -42, },
    {32, -110, -4, 116, -114, -90, 27, 110, -124, 44, -93, -61, 77, -104, -77, 117, 91, 25, -99, 12, -72, -22, -37, 60, -91, -61, 103, -45, -78, -93, -11, -30, -74, -121, 27, 119, -80, 42, 7, 101, },
    {-25, -87, 18, 50, 5, 92, 75, -49, -72, -16, 69, -3, 102, -20, 17, 54, -49, -113, 63, 100, -8, 125, 71, -79, -13, 91, -104, -1, 22, 85, 38, 128, 54, -48, 79, -101, -37, -7, -125, 57, },
    {126, 70, -59, 103, -77, -36, -102, 15, 54, -84, 113, -109, 41, -32, -125, 81, -13, 109, -29, -57, 46, -109, 21, 109, 10, -30, 51, 76, 116, -126, -55, 8, -87, -3, -23, -62, 66, 107, -52, -74, },
    {-102, -12, -43, -122, 30, 66, -8, 128, -29, 88, 24, -43, -70, 124, 27, -81, -96, 8, 35, -87, 77, -44, -65, 43, -122, -54, 32, -72, -21, -39, 68, 92, -110, 104, 35, 88, 14, -90, 26, 86, },
    {3, 40, 81, 118, -24, 45, -63, -109, 34, -58, -118, 9, 63, 94, -54, 47, 69, -67, 117, -123, 2, 94, -95, -3, 83, 101, -109, 62, 16, -97, -66, -15, 23, 61, -72, -119, 122, -16, 45, -33, },
    {-117, 21, -68, -98, 10, -87, 80, 100, -2, 71, 117, -14, -88, -102, -1, -25, 104, -42, 86, -16, 54, 30, 120, -23, -81, -38, 125, -86, -6, 107, 48, 120, -35, -99, -45, 1, 52, -107, -64, 111, },
    {64, -82, 97, 52, -51, 110, -119, -40, -78, -97, 46, -34, 106, 33, 85, -120, 15, -104, 23, -76, -32, -55, -113, 59, 72, 25, 5, -49, 90, 33, -117, -82, 80, 42, 114, -27, -80, 77, -46, 92, },
    {-21, -3, -36, 72, -14, 25, 2, 61, -20, 18, 82, -66, 53, -47, -74, -11, 58, -60, 124, 66, -98, 103, 16, -71, -12, -102, 52, -121, 77, -32, -56, 9, -9, -64, 18, 65, 97, 11, 31, -93, },
    {115, -59, -125, 125, -106, -73, 93, 42, 122, -52, -127, 4, -106, 21, 71, 110, -35, 37, -117, -7, 43, 77, -43, 111, 39, -59, 114, -18, -75, 20, 67, 102, -109, 89, -92, -127, -58, -7, -114, 58, },
    {17, 46, 6, 34, 86, -29, -57, -114, -86, 31, 109, 93, -26, 126, -114, -85, 94, 6, 80, -82, -23, 7, -127, -89, 81, -29, 93, -93, 43, 123, -101, -21, 56, -49, 34, 106, -18, 127, -38, -73, },
    {-103, 101, -87, -45, 57, -95, 105, 10, 67, -36, -10, -77, 59, -3, 42, -65, -18, -96, -46, 113, 92, -68, 58, -5, 26, -112, 12, 59, -62, -1, -40, -84, 118, 5, -31, 49, -85, 74, 40, 88, },
    {-27, 66, -15, -66, 19, -6, 74, -22, -67, 50, -102, 76, -91, -56, -39, 19, 117, 53, 25, -57, -109, 34, 128, -38, 97, -79, -48, -12, 107, -123, 38, 75, 26, -118, 83, -68, 22, -111, 2, -53, },
    {28, -116, 111, 81, -122, 120, 37, -109, 111, 88, -49, 13, 29, 100, 83, -103, 72, -124, -4, 64, -29, 14, -97, -55, 47, 117, 70, -107, 82, 16, 99, -55, -74, -6, -100, 114, -44, 60, -94, 118, },
    {-77, -37, 0, 48, -79, -54, -39, -90, 23, -5, -115, 121, -21, -121, 48, 7, -31, -71, 106, 43, -84, 102, 68, -17, -121, 1, 34, -36, -72, -28, -94, 51, -17, 95, 69, 12, -21, 100, -9, 78, },
};
#else
int8_t noise_map[32][32] = {
    {52, -115, -15, 18, -54, 121, -117, 93, 108, -57, -2, -25, -74, -48, 74, -64, -22, -98, 94, 63, -58, 2, -42, 117, 23, 46, 5, -126, 39, 20, -93, 7, },
    {106, 31, 86, -75, 103, -10, 54, -37, 44, -122, 80, -110, 98, 111, 33, -4, 86, -76, 37, -11, 124, -96, 33, -111, -70, 90, -14, -32, 58, -67, -47, -24, },
    {-105, -60, -40, 59, 39, -103, -79, 14, -19, -71, 123, 50, -12, -87, -38, -117, 115, -50, 50, -125, -27, 85, 53, 104, -54, -91, 77, 112, -79, -3, 121, 73, },
    {-84, -7, 126, -125, 3, -26, 89, 69, -95, 29, -53, 5, -101, 20, 44, 61, -104, 6, 105, 22, -65, -83, 10, -21, 66, -39, 14, -103, 30, 82, -119, 24, },
    {48, 68, 15, -90, 77, -49, -64, 118, -5, 96, 60, -33, 70, 89, -57, -18, 79, -34, -92, 68, -44, 98, -119, -5, 123, 38, -117, 102, -61, -17, -37, 99, },
    {-51, -20, -68, 99, 28, 109, -117, 21, -106, -41, -83, 111, -68, -112, 124, -81, 15, -70, 120, -13, 42, 75, 29, -105, -77, 51, 3, -48, 62, 43, -96, 8, },
    {-114, 87, -100, -35, 46, -13, 57, -29, 83, 40, -126, 14, -21, 30, -3, 97, 36, 55, -116, 1, -102, -56, 114, -32, -64, 86, -25, -86, 128, 89, -73, 113, },
    {56, 35, 118, -1, -110, -74, -88, 4, -59, 127, -10, 54, 104, -93, -43, -123, -27, -52, 87, 103, -75, 16, 59, -9, 107, 68, -98, 20, -13, -125, 27, -30, },
    {-10, -82, 19, -46, 73, 91, 115, 30, 63, -98, -76, 74, -55, 85, 45, 67, 117, -86, 25, -41, -23, 81, -92, -45, 9, -116, 98, 41, -67, 2, 76, -57, },
    {105, 80, -123, 53, -56, 12, -38, -119, 100, -23, -47, 24, -110, 4, -66, -14, -100, 7, 63, -111, 50, 125, -126, 45, -81, 28, -55, -38, 108, -108, 64, -94, },
    {7, -65, -25, 125, -97, 38, -16, -69, 78, -1, 48, 120, -30, -85, 110, 21, 80, -59, 106, -7, 32, -65, 93, -18, 75, 121, -3, 82, 51, -27, 119, -43, },
    {-106, 44, 97, -5, -80, 110, 60, -107, 21, -92, 88, -121, 39, 92, 57, -38, -121, 41, -77, -33, -99, 2, -52, 22, -34, -71, -113, -89, 13, -77, 36, 22, },
    {-17, 61, -114, 29, -31, 71, 4, -51, 117, -35, -62, 11, -16, -104, -72, -1, 127, -19, 95, 71, 114, -87, 58, 109, -102, 47, 66, -19, 96, -121, -54, 91, },
    {122, -72, -40, 78, -62, -122, -88, 41, 94, 54, -79, 70, 101, -50, 34, 76, -90, -51, 23, -118, -43, 81, 13, -121, -7, 101, 32, -48, 116, -6, 55, -88, },
    {2, -97, 102, 12, 89, 24, 106, -9, -23, -118, 27, -6, -94, 116, -25, 17, -112, 60, 5, 49, -14, 37, -73, 90, -40, -60, 8, -99, 72, -70, 84, -33, },
    {69, 37, -54, -15, -107, 49, -46, -68, -100, 82, 122, -43, 62, -127, 49, -63, 85, 117, -79, -105, -61, 124, -24, -93, 64, 121, -83, -28, 23, 43, -112, 16, },
    {107, -127, 55, 114, -78, -28, 128, 74, 19, 3, -56, 40, -73, 9, 96, -39, -11, 32, -29, 101, 69, 0, -113, 51, 17, -12, 83, -124, 99, -15, -46, -62, },
    {24, -23, -91, -2, 65, 10, -115, 34, -82, 102, -108, -28, 111, -16, -85, -106, 108, -70, -95, 15, 84, -52, 28, 108, -68, -108, 38, 58, -78, 126, -105, 90, },
    {-84, 119, -39, 82, -63, 94, -95, 57, -37, -14, 66, 88, -115, 29, 80, 70, 0, 43, -47, 55, -124, -84, -33, 74, -45, 1, 115, -55, -36, 6, 53, -8, },
    {-69, 46, 12, -118, 40, -48, -6, 113, -61, 45, -90, 13, -66, 53, -49, 19, -118, 125, -20, 95, -5, 118, 40, -101, 91, -87, -20, 21, 78, -93, 33, 71, },
    {-50, 96, -99, 27, 106, -80, -24, 79, -125, 25, 124, -45, -4, 116, -95, -30, -61, 65, -101, -75, 25, -63, -17, 10, 47, 103, -119, 64, -66, 109, -122, -29, },
    {-110, 76, -12, -32, 62, -109, 18, 98, 5, -75, 73, -102, -21, 92, -77, 104, 31, 88, 11, -35, 78, 107, -111, 69, -76, -53, 31, -103, 93, -17, 1, 123, },
    {56, -76, 112, -58, 1, 125, 52, -97, -53, -28, 105, 35, 59, -124, 42, 6, -16, -87, 47, -120, 58, -90, -42, -2, 128, -31, -8, 13, -41, -81, 41, 18, },
    {-46, 7, 35, -89, 83, -72, -42, 32, 67, -8, -115, -59, 16, -35, 77, -109, -44, 110, -55, 122, -26, 34, 18, 83, -98, 56, 87, 116, 49, -59, 103, -94, },
    {91, -126, 67, -36, 44, -120, -18, 92, -85, 47, 120, 84, -82, -6, 126, -67, 68, -104, -9, 4, -72, 100, -57, -127, 42, -67, -86, -116, 66, -107, 81, -22, },
    {-71, 122, -7, -104, 109, 14, -64, 115, -108, 9, -39, -99, 102, -51, 26, 50, 95, 19, 38, 86, -113, 67, -11, 113, -22, 9, -47, -13, 20, -34, -4, 30, },
    {46, -60, -26, 23, 94, 59, -2, 77, 26, -22, -69, 34, 62, -19, -91, -116, -26, -80, -36, -96, 51, -44, -83, 26, 61, 95, 123, 37, 75, -78, 113, -114, },
    {12, 100, 73, -82, -50, -114, -32, -91, -53, 70, 97, 0, -120, 79, 114, 10, -58, 119, 75, 104, -63, 11, 90, -109, -36, -92, -120, -62, 105, -97, -49, 60, },
    {-89, -40, -102, 35, -12, -74, 128, 39, -127, 110, -80, 52, 17, -41, -74, 36, 61, 0, -124, 25, -24, 126, -4, 72, -71, 48, -1, -27, 54, 8, 87, -18, },
    {-123, 81, 118, 6, 48, 101, 84, 15, 57, -9, -29, -109, -60, 107, -11, 92, -107, -49, -15, 45, -88, -103, 36, -52, 112, 16, 85, 31, -112, -73, 127, 26, },
    {42, -3, -65, 63, -111, -42, -21, -66, -101, -45, 120, 88, 43, -96, -31, 52, -85, 72, 112, -69, 99, 56, -30, -122, 97, -20, -84, -44, 72, -10, -34, -56, },
    {-81, 111, -31, -94, 76, 28, -86, 3, 71, 33, -89, 22, 65, 8, -123, 127, 27, 11, -37, -113, 17, 79, -78, -8, 64, -100, -58, 119, 100, -106, 65, 93, },
};
#endif
#endif

uint8_t add_saturate(uint8_t a, int8_t b) {
    int32_t val = (int32_t)a + (int32_t)b;
    if (val > 255) return 255;
    if (val < 0) return 0;
    return val;
}

// Process image to be displayed on EPD
void disp_filtering_image(Canvas *src, Rect src_rect, Rect dst_rect) {
    uint8_t *src_raw = (uint8_t *)src->buf;
#if defined(BUILD_PC_SIM)
    uint32_t *dst_raw = (uint32_t *)screen->buf;
#elif defined(BUILD_NEKOINK)
    uint8_t *dst_raw = (uint8_t *)screen->buf;
#endif
    uint32_t dst_w = screen->width;
    uint32_t src_x = src_rect.x;
    uint32_t src_y = src_rect.y;
    uint32_t w = src_rect.w;
    uint32_t h = src_rect.h;
    uint32_t dst_x = dst_rect.x;
    uint32_t dst_y = dst_rect.y;
    if ((w == 0) && (h == 0)) {
        w = src->width;
        h = src->height;
    }

#ifdef ENABLE_COLOR
    assert(src->pixelFormat == PIXFMT_RGB888);
#else
    assert(src->pixelFormat == PIXFMT_Y8);
#endif

#ifdef DITHERING_ERROR_DIFFUSION
    #ifdef DITHERING_GAMMA_AWARE
    float *err_buf = malloc(w * DITHERING_ERRBUF_LINES * sizeof(float));
    #else
    int32_t *err_buf = malloc(w * DITHERING_ERRBUF_LINES * sizeof(int32_t));
    #endif
    assert(err_buf);
#endif

#define SRC_PIX(x, y, comp) src_raw[((src_y + y) * w + src_x + x) * 3 + comp]
#define DST_PIX(x, y) dst_raw[(dst_y + y) * dst_w + dst_x + x]

    // Convert to 8bpp in target buffer
    for (int y = 0; y < h; y++) {
        for (int x = 0; x < w; x++) {
            uint8_t pix;
#ifdef ENABLE_COLOR
            uint32_t comp = get_panel_color_component(dst_x + x, dst_y + y);
            pix = SRC_PIX(x, y, comp);
    #ifdef ENABLE_LPF
            // Low pass filtering to reduce the color/ jagged egdes
            uint32_t pix_u = (y == 0) ? pix : SRC_PIX(x, y - 1, comp);
            uint32_t pix_d = (y == (h - 1)) ? pix : SRC_PIX(x, y + 1, comp);
            uint32_t pix_l = (x == 0) ? pix : SRC_PIX(x - 1, y, comp);
            uint32_t pix_r = (x == (w - 1)) ? pix : SRC_PIX(x + 1, y, comp);
            pix = pix >> 1; // /2
            pix_u = pix_u >> 3; // /8
            pix_d = pix_d >> 3;
            pix_l = pix_l >> 3;
            pix_r = pix_r >> 3;
            pix = pix + pix_u + pix_d + pix_l + pix_r;
    #endif
#else
            pix = src_raw[(src_y + y) * w + src_x + x];
#endif
            DST_PIX(x, y) = pix;
        }
    }

#ifdef DITHERING_ERROR_DIFFUSION
    memset(err_buf, 0, w * DITHERING_ERRBUF_LINES * sizeof(*err_buf));
#endif

    // Quantize color into requested bit depth and do optional dithering
    for (int y = 0; y < h; y++) {
        for (int x = 0; x < w; x++) {
            int32_t pix = (int32_t)DST_PIX(x, y);
    
#ifdef DITHERING_ERROR_DIFFUSION
            // Add in error term
    #ifdef DITHERING_GAMMA_AWARE
            float pix_linear = srgb_to_linear(pix);
            pix_linear += err_buf[(y % DITHERING_ERRBUF_LINES) * w + x];
            pix = linear_to_srgb(pix_linear);
    #else
            pix += err_buf[(y % DITHERING_ERRBUF_LINES) * w + x];
    #endif
#endif

#ifdef DITHERING_ORDERED
    #ifdef ENABLE_COLOR
            pix = add_saturate(pix, dithering_map[y % 6 * 6 + x % 6]);
    #else
            pix = add_saturate(pix, dithering_map[y % 4][x % 4]);
    #endif
#endif

#ifdef DITHERING_BLUE_NOISE
    #ifdef ENABLE_COLOR
            pix = add_saturate(pix, noise_map[y % 120][x / 3 % 40]);
    #else
            pix = add_saturate(pix, noise_map[y % 32][x % 32]);
    #endif
#endif

            // Quantize the pixel down to the bpp required
            int32_t new_pix;
#ifdef DEPTH_1BPP
            new_pix = (pix & 0x80) ? 0xff : 0x00;
#elif (defined(DEPTH_2BPP))
            new_pix = pix & 0xc0;
            new_pix |= new_pix >> 2;
            new_pix |= new_pix >> 4;
#elif (defined(DEPTH_4BPP))
            new_pix = pix & 0xf0;
            new_pix |= new_pix >> 4;
#elif (defined(DEPTH_8BPP))
            new_pix = pix;
#endif

#ifdef DITHERING_ERROR_DIFFUSION
            // Apply clipping
            if (pix < 0)
                new_pix = 0;
            else if (pix > 255)
                new_pix = 255;

            // Use error-diffusion dithering.
    #ifdef DITHERING_GAMMA_AWARE
            float quant_error = pix_linear - srgb_to_linear(new_pix);
    #else
            int32_t quant_error = (int32_t)pix - (int32_t)new_pix;
    #endif

            pix = new_pix;

    #define DIFFUSE_ERROR(x, y, w, h, error, factor, sum)\
            if (((y) > 0) && ((x) > 0) && ((y) < h) && ((x) < w)) \
                err_buf[((y) % DITHERING_ERRBUF_LINES) * w + x] += error * factor / sum;

    #ifdef ENABLE_COLOR
            // . . * . . 1
            // 2 . . 3 . .
            // . 4 . . 5 .
            // . . 6 . . .
            // Star is the pixel in question, the error is pushed to the pixels
            // labeled 1-6 (neighboring pixels in the same color).
            // 1.4-5, 1.7-3, 2.8-2, 3-2/1
            DIFFUSE_ERROR(x + 3, y + 0, w, h, quant_error, 2, 16); // 1 D=3
            DIFFUSE_ERROR(x - 2, y + 1, w, h, quant_error, 3, 16); // 2 D=1.7
            DIFFUSE_ERROR(x + 1, y + 1, w, h, quant_error, 5, 16); // 3 D=1.4
            DIFFUSE_ERROR(x - 1, y + 2, w, h, quant_error, 3, 16); // 4 D=1.7
            DIFFUSE_ERROR(x + 2, y + 2, w, h, quant_error, 2, 16); // 5 D=2.8
            DIFFUSE_ERROR(x    , y + 3, w, h, quant_error, 1, 16); // 6 D=3
    #else
            #if 0
            // Floyd-Steinberg
            // . * 1
            // 2 3 4
            // Star is the pixel in question, the error is pushed to the pixels
            // labeled 1-4
            DIFFUSE_ERROR(x + 1, y + 0, w, h, quant_error, 7, 16);
            DIFFUSE_ERROR(x - 1, y + 1, w, h, quant_error, 3, 16);
            DIFFUSE_ERROR(x    , y + 1, w, h, quant_error, 5, 16);
            DIFFUSE_ERROR(x + 1, y + 1, w, h, quant_error, 1, 16);
            #else
            // Two-Row Sierra
            DIFFUSE_ERROR(x + 1, y + 0, w, h, quant_error, 4, 16);
            DIFFUSE_ERROR(x + 2, y + 0, w, h, quant_error, 3, 16);
            DIFFUSE_ERROR(x - 2, y + 1, w, h, quant_error, 1, 16);
            DIFFUSE_ERROR(x - 1, y + 1, w, h, quant_error, 2, 16);
            DIFFUSE_ERROR(x,     y + 1, w, h, quant_error, 3, 16);
            DIFFUSE_ERROR(x + 1, y + 1, w, h, quant_error, 2, 16);
            DIFFUSE_ERROR(x + 2, y + 1, w, h, quant_error, 1, 16);
            #endif
    #endif
#else
            // Does not apply dithering
            pix = new_pix;
#endif
            DST_PIX(x, y) = pix;
        }
#ifdef DITHERING_ERROR_DIFFUSION
        // Clear errbuf of current line
        memset(&err_buf[(y % DITHERING_ERRBUF_LINES) * w], 0, w * sizeof(*err_buf));
#endif
    }

#ifdef DITHERING_ERROR_DIFFUSION
    free(err_buf);
#endif

#if defined(BUILD_PC_SIM)
    // Reformat for ARGB8888 buffer
    for (int y = 0; y < h; y++) {
        for (int x = 0; x < w; x++) {
            uint32_t pix = DST_PIX(x, y);
    #ifdef ENABLE_COLOR
            uint32_t shift = get_panel_color_shift(dst_x + x, dst_y + y);
            pix <<= shift;
            //pix |= (pix << 16) | (pix << 8);
    #else
            pix |= (pix << 16) | (pix << 8);
    #endif
            pix |= 0xff000000;
            DST_PIX(x, y) = pix;
        }
    }

    #ifdef ENABLE_BRIGHTEN
    // Brighten image, not recommended
    for (int y = 0; y < h; y++) {
        for (int x = 0; x < (w - 1); x++) {
            uint32_t pix = DST_PIX(x, y);
            uint32_t shift = get_panel_color_shift(x, y);
            uint32_t cm = 0xff << shift;
            pix &= cm;
            DST_PIX(x + 1, y) |= pix;
            if (y < (h - 1))
                DST_PIX(x + 1, y + 1) |= pix;
        }
    }
    #endif

    uint32_t *texture_pixels;
    int texture_pitch;
    SDL_LockTexture(texture, NULL, (void **)&texture_pixels, &texture_pitch);
    assert(texture_pitch == (screen->width * 4));
    memcpy(texture_pixels, screen->buf, screen->height * texture_pitch);
    SDL_UnlockTexture(texture);
#elif defined(BUILD_NEKOINK)
    // TODO: Directly write into FB?
    uint8_t *wrptr = fbdev_fb;
    uint8_t *rdptr = dst_raw;
    for (int i = 0; i < screen->height; i++) {
        memcpy(wrptr, rdptr, screen->width);
        wrptr += fb_virtual_x;
        rdptr += screen->width;
    }
#endif

}

void disp_init(void) {

#if (defined(DITHERING_ERROR_DIFFUSION) && defined(DITHERING_GAMMA_AWARE))
    build_gamma_table();
#endif

#if defined(BUILD_PC_SIM)
    if (SDL_Init(SDL_INIT_VIDEO | SDL_INIT_EVENTS)) {
        fprintf(stderr, "SDL initialization error %s\n", SDL_GetError());
        exit(1);
    }

    window = SDL_CreateWindow(TITLE, SDL_WINDOWPOS_UNDEFINED,
            SDL_WINDOWPOS_UNDEFINED, DISP_WIDTH, DISP_HEIGHT,
            SDL_WINDOW_SHOWN | SDL_WINDOW_ALLOW_HIGHDPI);

    int w, h;
    SDL_GL_GetDrawableSize(window, &w, &h);
    // Detect 2X HiDPI screen, if high dpi, set to 1X size
    if (w == DISP_WIDTH * 2) {
        SDL_SetWindowSize(window, DISP_WIDTH / 2, DISP_HEIGHT / 2);
        SDL_GL_GetDrawableSize(window, &w, &h);
    }

    renderer = SDL_CreateRenderer(window, -1, SDL_RENDERER_ACCELERATED);

    texture = SDL_CreateTexture(renderer, SDL_PIXELFORMAT_ARGB8888,
            SDL_TEXTUREACCESS_STREAMING, w, h);

    screen = disp_create(w, h, PIXFMT_ARGB8888);
#elif defined(BUILD_NEKOINK)
    char devname[] = "/dev/fbxx";
    char epdcid[] = "mxc_epdc_fb";
    struct fb_fix_screeninfo fix_screeninfo;
    bool found = false;
    // Try to detect epdc fb device
    for (int i = 0; i < 3; i++) {
        sprintf(devname, "/dev/fb%d", i);
        fd_fbdev = open(devname, O_RDWR, 0);
        if (fd_fbdev < 0) {
            fprintf(stderr, "Failed to open fbdev %s\n", devname);
            exit(1);
        }
        if (ioctl(fd_fbdev, FBIOGET_FSCREENINFO, &fix_screeninfo) < 0) {
            fprintf(stderr, "Failed to get fixed screeninfo for %s\n", devname);
            exit(1);
        }
        if (!strcmp(fix_screeninfo.id, epdcid)) {
            printf("Opened EPDC device %s\n", devname);
            found = true;
            break;
        }
    }
    if (!found) {
        fprintf(stderr, "Failed to find and open EPDC device.\n");
        exit(1);
    }

    if (ioctl(fd_fbdev, FBIOGET_VSCREENINFO, &var_screeninfo) < 0) {
        fprintf(stderr, "Failed to get variable screeninfo\n");
        exit(1);
    }

    var_screeninfo.rotate = FB_ROTATE_UR;
    var_screeninfo.bits_per_pixel = 8;
    var_screeninfo.grayscale = GRAYSCALE_8BIT;
    var_screeninfo.yoffset = 0;
    var_screeninfo.activate = FB_ACTIVATE_FORCE;
    if (ioctl(fd_fbdev, FBIOPUT_VSCREENINFO, &var_screeninfo) < 0) {
        fprintf(stderr, "Failed to set screen mode\n");
        exit(1);
    }

    int w, h;
    w = var_screeninfo.xres_virtual;
    h = var_screeninfo.yres_virtual;
    fb_size = w * h * var_screeninfo.bits_per_pixel / 8;
    fb_virtual_x = w;
    printf("Virtual screen size: %d x %d\n", w, h);

    w = var_screeninfo.xres;
    h = var_screeninfo.yres;
    printf("Actual screen size: %d x %d\n", w, h);

    fbdev_fb = (uint8_t *)mmap(0, fb_size,
            PROT_READ | PROT_WRITE, MAP_SHARED, fd_fbdev, 0);
    if ((int32_t)fbdev_fb <= 0) {
        fprintf(stderr, "Failed to set screen mode\n");
        exit(1);
    }

    // Disable auto update mode (region mode)
    uint32_t auto_update_mode = AUTO_UPDATE_MODE_REGION_MODE;
    if (ioctl(fd_fbdev, MXCFB_SET_AUTO_UPDATE_MODE, &auto_update_mode) < 0) {
        fprintf(stderr, "Failed to set auto update mode\n");
        exit(1);
    }

    // Setup waveform mode for auto wave mode (not used)
    struct mxcfb_waveform_modes waveform_modes;
    waveform_modes.mode_init = (uint32_t)WVMD_INIT;
    waveform_modes.mode_du   = (uint32_t)WVMD_DU;
    waveform_modes.mode_gc4  = (uint32_t)WVMD_GC4;
    waveform_modes.mode_gc8  = (uint32_t)WVMD_GC16;
    waveform_modes.mode_gc16 = (uint32_t)WVMD_GC16;
    waveform_modes.mode_gc32 = (uint32_t)WVMD_GC16;
    if (ioctl(fd_fbdev, MXCFB_SET_WAVEFORM_MODES, &waveform_modes) < 0) {
        fprintf(stderr, "Failed to set waveform mode\n");
        exit(1);
    }

    // Set update scheme
    uint32_t scheme = UPDATE_SCHEME_QUEUE_AND_MERGE;
    if (ioctl(fd_fbdev, MXCFB_SET_UPDATE_SCHEME, &scheme) < 0) {
        fprintf(stderr, "Failed to set update scheme\n");
        exit(1);
    }

    // Set power down delay
    uint32_t powerdown_delay = 0;
    if (ioctl(fd_fbdev, MXCFB_SET_PWRDOWN_DELAY, &powerdown_delay) < 0) {
        fprintf(stderr, "Failed to set power down delay\n");
    }

    screen = disp_create(w, h, PIXFMT_Y8);

    // Clear screen
    Rect zero_rect = {0};
    memset(fbdev_fb, 0xff, fb_size);
    disp_present(zero_rect, WVMD_INIT, false, true);
    //memset(fbdev_fb, 0x00, fb_size);
    //disp_present(zero_rect, WVMD_GC16, true, true);
#endif
}

void disp_deinit(void) {
#if defined(BUILD_PC_SIM)
    SDL_DestroyWindow(window);
    SDL_Quit();
#elif defined(BUILD_NEKOINK)
    munmap(fbdev_fb, fb_size);
    close(fd_fbdev);
#endif
}

void disp_present(Rect dest_rect, WaveformMode mode, bool partial, bool wait) {
#if defined(BUILD_PC_SIM)
    SDL_RenderCopy(renderer, texture, NULL, NULL);
    SDL_RenderPresent(renderer);
#elif defined(BUILD_NEKOINK)
    if ((dest_rect.w == 0) && (dest_rect.h == 0)) {
        dest_rect.w = screen->width;
        dest_rect.h = screen->height;
    }
    struct mxcfb_update_data update_data;
    struct mxcfb_update_marker_data update_marker_data;

    update_data.update_mode = partial ? UPDATE_MODE_PARTIAL : UPDATE_MODE_FULL;
    update_data.waveform_mode = mode;
    update_data.update_region.left = dest_rect.x;
    update_data.update_region.top = dest_rect.y;
    update_data.update_region.width = dest_rect.w;
    update_data.update_region.height = dest_rect.h;
    update_data.temp = TEMP_USE_AMBIENT;
    update_data.flags = 0;

    if (wait)
        update_data.update_marker = ++marker_value;
    else
        update_data.update_marker = 0;

    if (ioctl(fd_fbdev, MXCFB_SEND_UPDATE, &update_data) < 0) {
        fprintf(stderr, "Failed sending udpdate\n");
        return;
    }

    if (wait) {
        update_marker_data.update_marker = marker_value;
        if (ioctl(fd_fbdev, MXCFB_WAIT_FOR_UPDATE_COMPLETE,
                &update_marker_data) < 0) {
            fprintf(stderr, "Failed waiting for update complete\n");
        }
    }
#endif
}

Canvas *disp_load_image(char *filename) {
    int x, y, n;
    unsigned char *data = stbi_load(filename, &x, &y, &n, 0);
    PixelFormat fmt;
    if (n == 1)
        fmt = PIXFMT_Y8;
    else if (n == 3)
        fmt = PIXFMT_RGB888;
    else if (n == 4)
        fmt = PIXFMT_RGBA8888_BE;
    else
        return NULL; // YA88 not supported
    Canvas *canvas = disp_create(x, y, fmt);
    memcpy(canvas->buf, data, x * y * n);
    return canvas;
}
